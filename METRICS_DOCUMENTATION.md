# Claude Usage Tracker - Metrics & Cost Calculation Documentation

## ðŸ“Š Table of Contents

1. [Overview](#overview)
2. [Token Types & Definitions](#token-types--definitions)
3. [Cost Calculation Methods](#cost-calculation-methods)
4. [Session Metrics](#session-metrics)
5. [Platform Analytics](#platform-analytics)
6. [Project Analytics](#project-analytics)
7. [Time-Based Analytics](#time-based-analytics)
8. [Cost Efficiency Analysis](#cost-efficiency-analysis)
9. [Data Sources & Collection](#data-sources--collection)
10. [API Endpoints Reference](#api-endpoints-reference)

---

## Overview

The Claude Usage Tracker provides comprehensive analytics for Claude AI usage across different platforms (VS Code, Web, API). All metrics are derived from real `ccusage` CLI data with no simulated or mock data.

### Key Data Sources
- **ccusage CLI**: Primary data source for all metrics
- **Real-time Collection**: Data refreshes every 2 minutes automatically
- **Multi-platform Support**: VS Code, Web, and API usage tracking
- **Project-wise Breakdown**: Workspace-specific analytics

---

## Token Types & Definitions

### ðŸ”¢ Token Categories

| Token Type | Description | Cost Impact | Typical Usage |
|------------|-------------|-------------|---------------|
| **Input Tokens** | Tokens sent to Claude (prompts, context) | Medium cost per token | User prompts, code context |
| **Output Tokens** | Tokens generated by Claude (responses) | High cost per token | Claude responses, generated code |
| **Cache Creation Tokens** | Tokens used to create context cache | Low cost per token | Initial context processing |
| **Cache Read Tokens** | Tokens read from existing cache | Very low cost | Subsequent requests with same context |

### ðŸ“Š Token Distribution Analysis

```javascript
// Real example from ccusage data
{
  "inputTokens": 15420,          // ~1% of total
  "outputTokens": 8930,          // ~1% of total  
  "cacheCreationTokens": 450000, // ~30% of total
  "cacheReadTokens": 985000,     // ~68% of total
  "totalTokens": 1459350         // 100%
}
```

### ðŸŽ¯ Key Insights
- **Cache tokens represent 98%+ of total usage** - This is normal and expected
- **Direct processing tokens (input/output) are typically <5%** of total
- **Cache efficiency** dramatically reduces per-interaction costs

---

## Cost Calculation Methods

### ðŸ’° Pricing Structure (Per 1M Tokens)

| Model | Input Tokens | Output Tokens | Cache Write | Cache Read |
|-------|--------------|---------------|-------------|------------|
| **Claude-3 Opus** | $15.00 | $75.00 | $3.75 | $0.30 |
| **Claude-3 Sonnet** | $3.00 | $15.00 | $0.75 | $0.06 |
| **Claude-3 Haiku** | $0.25 | $1.25 | $0.06 | $0.005 |

### ðŸ§® Cost Calculation Formula

```javascript
// Cost calculation per session
const calculateCost = (session) => {
  const model = session.model; // e.g., 'claude-3-sonnet'
  const rates = PRICING[model];
  
  const inputCost = (session.inputTokens / 1_000_000) * rates.input;
  const outputCost = (session.outputTokens / 1_000_000) * rates.output;
  const cacheWriteCost = (session.cacheCreationTokens / 1_000_000) * rates.cacheWrite;
  const cacheReadCost = (session.cacheReadTokens / 1_000_000) * rates.cacheRead;
  
  return inputCost + outputCost + cacheWriteCost + cacheReadCost;
};
```

### ðŸ’¡ Cost Optimization Insights

1. **Cache Usage is Cost-Effective**: Reading from cache costs ~95% less than new processing
2. **Context Management**: Larger contexts create expensive cache but save on repeated processing  
3. **Model Selection**: Haiku is 12x cheaper than Opus for same token count
4. **Session Batching**: Multiple interactions in same context leverage cache efficiency

---

## Session Metrics

### ðŸ“‹ Session Definition
A **session** represents a single interaction or conversation thread with Claude, containing all associated tokens and metadata.

### ðŸ” Session Data Structure

```typescript
interface UsageSession {
  id: string;                    // Unique session identifier
  timestamp: string;             // ISO datetime of session
  platform: 'vscode' | 'web' | 'api';  // Platform used
  userId: string;                // System username
  
  // Token counts
  inputTokens: number;           // User input tokens
  outputTokens: number;          // Claude response tokens  
  totalTokens: number;           // Sum of all token types
  
  // Cost data
  cost: number;                  // Total cost in USD
  model: string;                 // Claude model used
  
  // Session metadata
  sessionDuration: number;       // Duration in minutes
  
  // Platform-specific data
  vscodeData?: {
    projectPath: string;         // VS Code project path
    projectName: string;         // Project name
    programmingLanguage: string; // Primary language
    filesModified: number;       // Files changed
    codeGenerated: boolean;      // Whether code was generated
    linesAdded: number;          // Lines of code added
    linesDeleted: number;        // Lines of code deleted
    commandUsed: string;         // Type of assistance
    cacheCreationTokens: number; // Cache creation tokens
    cacheReadTokens: number;     // Cache read tokens
  };
  
  webData?: {
    conversationLength: number;  // Messages in conversation
    topicCategory: string;       // Conversation topic
  };
}
```

### ðŸ“ˆ Session Analytics

#### **Daily Session Metrics**
```javascript
// Example daily session summary
{
  "date": "2025-01-08",
  "sessions": 45,              // Total sessions today
  "totalTokens": 2450000,      // All tokens processed
  "totalCost": 12.45,          // Total cost in USD
  "averageTokensPerSession": 54444, // Avg tokens/session
  "averageCostPerSession": 0.2767,  // Avg cost/session
  "platforms": {
    "vscode": 38,              // VS Code sessions  
    "web": 7                   // Web sessions
  }
}
```

#### **Session Duration Calculation**
```javascript
// Duration estimation based on token processing
const estimateSessionDuration = (totalTokens) => {
  // Approximately 10,000 tokens = 1 minute of processing time
  return Math.ceil(totalTokens / 10000);
};
```

---

## Platform Analytics

### ðŸ–¥ï¸ Platform Categories

#### **VS Code Platform**
- **Usage**: Code generation, refactoring, debugging
- **Token Pattern**: High cache usage due to code context
- **Typical Cost**: Lower per-interaction due to cache efficiency
- **Metrics Tracked**:
  - Project-wise breakdown
  - Programming language distribution  
  - Code generation frequency
  - File modification counts

#### **Web Platform**  
- **Usage**: General conversations, research, writing
- **Token Pattern**: More balanced input/output ratio
- **Typical Cost**: Higher per-token due to less caching
- **Metrics Tracked**:
  - Conversation length
  - Topic categories
  - Session frequency

#### **API Platform**
- **Usage**: Programmatic access, integrations
- **Token Pattern**: Variable based on implementation
- **Typical Cost**: Depends on caching strategy
- **Metrics Tracked**:
  - Request patterns
  - Integration usage

### ðŸ“Š Platform Metrics Structure

```typescript
interface PlatformMetrics {
  platform: 'vscode' | 'web' | 'api';
  sessions: number;                    // Total sessions
  totalTokens: number;                 // All tokens used
  totalCost: number;                   // Total cost in USD
  averageSessionDuration: number;      // Avg duration in minutes
  percentageOfTotal: number;           // % of total usage
}
```

### ðŸŽ¯ Platform Efficiency Analysis

```javascript
// Platform efficiency comparison
const platformEfficiency = {
  "vscode": {
    "tokensPerDollar": 425000,         // High due to cache usage
    "averageCostPerSession": 0.18,     // Low cost per session
    "cacheHitRate": 0.94               // 94% cache usage
  },
  "web": {
    "tokensPerDollar": 180000,         // Lower efficiency
    "averageCostPerSession": 0.45,     // Higher cost per session  
    "cacheHitRate": 0.23               // 23% cache usage
  }
};
```

---

## Project Analytics

### ðŸ“ Project Definition
A **project** represents a specific VS Code workspace or development environment with its own context and usage patterns.

### ðŸ—ï¸ Project Data Structure

```typescript
interface ProjectData {
  path: string;                  // Full project path
  sessions: UsageSession[];      // All project sessions
  totalTokens: number;           // Project total tokens
  totalCost: number;             // Project total cost  
  sessionCount: number;          // Number of sessions
}

interface ProjectMetrics {
  name: string;                  // Project display name
  path: string;                  // Project path
  sessions: number;              // Session count
  totalTokens: number;           // Total tokens used
  totalCost: number;             // Total cost in USD
  percentageOfTotal: number;     // % of total usage
  averageSessionDuration: number; // Avg duration in minutes
  lastActivityDate: string;      // Last session date
}
```

### ðŸ“Š Project Analytics Examples

#### **Top Project by Usage**
```javascript
{
  "name": "claude-usage-tracker",
  "path": "/Users/dev/projects/claude-usage-tracker",
  "sessions": 127,
  "totalTokens": 15420000,       // 15.4M tokens
  "totalCost": 245.67,           // $245.67 total
  "percentageOfTotal": 67.3,     // 67% of all usage
  "averageSessionDuration": 8.5, // 8.5 min per session
  "lastActivityDate": "2025-01-08T14:30:00Z"
}
```

#### **Project Efficiency Ranking**
```javascript
// Projects ranked by cost efficiency (tokens per dollar)
const projectEfficiency = [
  {
    "name": "large-codebase",
    "tokensPerDollar": 580000,    // Most efficient (high cache usage)
    "cacheHitRate": 0.97
  },
  {
    "name": "small-script", 
    "tokensPerDollar": 120000,    // Less efficient (low cache reuse)
    "cacheHitRate": 0.34
  }
];
```

### ðŸŽ¯ Project Insights

1. **Large Projects = Higher Efficiency**: More context caching opportunities
2. **Repeated Work = Lower Costs**: Cache reuse reduces per-interaction cost
3. **Language Impact**: Some languages have more verbose contexts
4. **Development Phase**: Active development shows higher token usage

---

## Time-Based Analytics

### ðŸ“… Weekly Analytics

#### **Data Structure**
```typescript
interface WeeklyData {
  week: string;                  // Week start date (YYYY-MM-DD)
  inputTokens: number;           // Week input tokens
  outputTokens: number;          // Week output tokens  
  cacheCreationTokens: number;   // Week cache creation
  cacheReadTokens: number;       // Week cache reads
  totalTokens: number;           // Week total tokens
  totalCost: number;             // Week total cost
  modelsUsed: string[];          // Models used this week
}
```

#### **Weekly Growth Calculation**
```javascript
const calculateWeeklyGrowth = (currentWeek, previousWeek) => {
  if (!previousWeek) return 0;
  
  const growth = ((currentWeek.totalCost - previousWeek.totalCost) / previousWeek.totalCost) * 100;
  return parseFloat(growth.toFixed(1));
};

// Example: +23.5% week-over-week growth
```

#### **Weekly Insights**
```javascript
{
  "weekOf": "2025-01-06",
  "totalCost": 89.23,
  "tokensProcessed": 12500000,
  "sessionsCompleted": 156,
  "topProject": "ai-assistant-bot",
  "costGrowth": "+15.2%",        // vs previous week
  "efficiency": 140082,          // tokens per dollar
  "cacheEfficiency": 0.96        // 96% cache usage
}
```

### ðŸ—“ï¸ Monthly Analytics

#### **Data Structure**  
```typescript
interface MonthlyData {
  month: string;                 // Month (YYYY-MM format)
  inputTokens: number;           // Month input tokens
  outputTokens: number;          // Month output tokens
  cacheCreationTokens: number;   // Month cache creation
  cacheReadTokens: number;       // Month cache reads
  totalTokens: number;           // Month total tokens
  totalCost: number;             // Month total cost
  modelsUsed: string[];          // Models used this month
}
```

#### **Monthly Trend Analysis**
```javascript
const monthlyTrends = {
  "2025-01": {
    "totalCost": 445.67,
    "totalTokens": 67890000,
    "averageDailyCost": 14.38,
    "peakUsageDay": "2025-01-15",   // Highest usage day
    "costPerToken": 0.00000657,     // $0.00000657 per token
    "efficiency": "High",           // Based on cache usage
    "monthlyGrowth": "+28.4%"       // vs previous month
  }
};
```

#### **Seasonal Patterns**
```javascript
// Usage patterns by month
const seasonalAnalysis = {
  "workingMonths": {              // Jan, Sep-Nov (high activity)
    "avgMonthlyCost": 380.50,
    "avgTokens": 58000000
  },
  "holidayMonths": {              // Dec, Jun-Aug (lower activity)  
    "avgMonthlyCost": 125.30,
    "avgTokens": 19000000
  }
};
```

---

## Cost Efficiency Analysis

### âš¡ Efficiency Metrics

#### **Tokens Per Dollar**
```javascript
// Higher is better - more tokens processed per dollar spent
const tokensPerDollar = totalTokens / totalCost;

// Efficiency categories:
// - Excellent: >400,000 tokens/$  (High cache usage)
// - Good: 200,000-400,000 tokens/$ (Moderate cache usage)  
// - Fair: 100,000-200,000 tokens/$ (Low cache usage)
// - Poor: <100,000 tokens/$       (Inefficient usage)
```

#### **Cache Efficiency Ratio**
```javascript
const cacheEfficiency = (cacheReadTokens + cacheCreationTokens) / totalTokens;

// Efficiency levels:
// - Excellent: >90% cache usage
// - Good: 70-90% cache usage
// - Fair: 40-70% cache usage  
// - Poor: <40% cache usage
```

#### **Cost Per Session Analysis**
```javascript
const avgCostPerSession = totalCost / sessionCount;

// Benchmarks by platform:
// - VS Code: $0.15-0.25 (efficient due to caching)
// - Web: $0.35-0.55 (higher due to diverse conversations)
// - API: $0.10-0.40 (varies by implementation)
```

### ðŸŽ¯ Optimization Recommendations

#### **High Efficiency Patterns**
1. **Context Reuse**: Multiple interactions within same project
2. **Batch Processing**: Group related tasks in single session
3. **Model Selection**: Use Haiku for simple tasks, Sonnet for complex
4. **Cache Leverage**: Work on same codebase repeatedly

#### **Cost Reduction Strategies**
```javascript
const optimizationStrategies = {
  "contextManagement": {
    "description": "Maintain consistent context within sessions",
    "potentialSavings": "60-80%",
    "implementation": "Keep related questions in same conversation"
  },
  "modelSelection": {
    "description": "Use appropriate model for task complexity", 
    "potentialSavings": "70-90%",
    "implementation": "Haiku for simple tasks, Sonnet for complex"
  },
  "sessionBatching": {
    "description": "Group related tasks together",
    "potentialSavings": "40-60%", 
    "implementation": "Plan multiple questions before starting session"
  }
};
```

---

## Data Sources & Collection

### ðŸ”„ Data Collection Process

#### **Primary Data Source: ccusage CLI**
```bash
# Commands executed every 2 minutes
ccusage daily --instances --json    # Project-wise daily data
ccusage daily --json               # Overall daily data  
ccusage weekly --json              # Weekly aggregates
ccusage monthly --json             # Monthly aggregates
ccusage session --json             # Individual sessions
ccusage blocks --json              # 5-hour billing blocks
```

#### **Data Processing Pipeline**
```javascript
const dataProcessingFlow = {
  1: "Raw ccusage data collection",
  2: "Token aggregation and validation", 
  3: "Cost calculation with current pricing",
  4: "Platform and project categorization",
  5: "Time-based aggregation (daily/weekly/monthly)",
  6: "Efficiency metrics calculation",
  7: "Real-time dashboard updates"
};
```

#### **Data Refresh Schedule**
- **Automatic Collection**: Every 2 minutes
- **Full Refresh**: On server restart
- **Manual Trigger**: Via API endpoint `/api/ccusage/refresh`

### ðŸ”§ Data Quality Assurance

#### **Validation Checks**
```javascript
const dataValidation = {
  "tokenConsistency": "totalTokens = input + output + cacheCreate + cacheRead",
  "costAccuracy": "Recalculated using current model pricing",
  "timelineIntegrity": "Sessions ordered chronologically",
  "projectMapping": "Consistent project path â†’ name mapping",
  "platformClassification": "Accurate platform detection"
};
```

#### **Error Handling**
- **Missing Data**: Graceful fallbacks and user notifications
- **API Failures**: Retry logic with exponential backoff
- **Inconsistent Tokens**: Data validation and correction
- **Cost Mismatches**: Recalculation using latest pricing

---

## API Endpoints Reference

### ðŸ“¡ Available Endpoints

#### **Core Data Endpoints**
```javascript
// Get current usage sessions
GET /api/ccusage
Response: UsageSession[]

// Get project-wise breakdown  
GET /api/ccusage/projects
Response: Record<string, ProjectData>

// Get weekly analytics
GET /api/ccusage/weekly  
Response: WeeklyData[]

// Get monthly analytics
GET /api/ccusage/monthly
Response: MonthlyData[]

// Get individual sessions
GET /api/ccusage/sessions
Response: SessionData[]

// Get billing blocks (5-hour cycles)
GET /api/ccusage/blocks
Response: BillingBlock[]
```

#### **Management Endpoints**
```javascript
// Get service status
GET /api/ccusage/status
Response: {
  isRunning: boolean,
  ccusageInstalled: boolean,
  lastDataCount: number,
  projectCount: number,
  lastUpdate: string
}

// Manual data refresh
POST /api/ccusage/refresh  
Response: {
  success: boolean,
  dataCount: number
}
```

### ðŸŽ¨ Frontend Data Consumption

#### **Real-time Data Context**
```javascript
// Centralized data management
const { state, actions } = useData();

// Available state properties
state.sessions              // All usage sessions
state.dashboardMetrics     // Processed dashboard data
state.platformMetrics      // Platform comparison data  
state.projectData          // Project analytics
state.weeklyData           // Weekly trends
state.monthlyData          // Monthly trends
state.isLoading            // Loading state
state.selectedProject      // Current project filter
state.systemUser           // Current system user

// Available actions
actions.refreshData()       // Manual data refresh
actions.setSelectedProject() // Project filtering
actions.getTodayData()      // Today's metrics
actions.getTimeSeriesData() // Historical trends
```

---

## ðŸ“‹ Summary

### Key Takeaways

1. **Cost Structure**: 98%+ of costs come from cache tokens (normal and efficient)
2. **Efficiency Optimization**: Focus on context reuse and appropriate model selection
3. **Platform Differences**: VS Code shows higher efficiency due to code context caching
4. **Project Analytics**: Larger projects typically show better cost efficiency
5. **Time Trends**: Weekly and monthly analysis reveals usage patterns

### Monitoring Recommendations

1. **Track Cost per Session** across platforms
2. **Monitor Cache Efficiency** ratios  
3. **Analyze Project Performance** for optimization opportunities
4. **Review Monthly Trends** for budget planning
5. **Optimize Model Usage** based on task complexity

This documentation provides complete transparency into how all metrics are calculated, costs are determined, and data is processed in the Claude Usage Tracker system.